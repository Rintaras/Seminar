# 実行環境アーキテクチャ

## 🏗️ 全体構成図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          ホストマシン（macOS/Windows/Linux）                │
│                                                                         │
│  📁 vol.2/                                                              │
│  ├── scripts/                                                          │
│  │   ├── run-experiments.sh      ← 複数条件のベンチマーク制御            │
│  │   ├── run-benchmark.sh        ← 単一条件のベンチマーク実行            │
│  │   ├── set-network-conditions.sh ← ネットワーク条件設定（tc）          │
│  │   └── analyze_results.py      ← グラフ生成・分析                     │
│  ├── results/                    ← 📊 結果ファイル（ホストと共有）       │
│  │   └── session_YYYYMMDD_HHMMSS_name/                                 │
│  │       ├── session_info.txt                                          │
│  │       ├── delay_Xms_bw_Y/                                           │
│  │       │   ├── http2_results.csv                                     │
│  │       │   ├── http3_results.csv                                     │
│  │       │   └── experiment_info.txt                                   │
│  │       └── analysis/                                                 │
│  │           ├── ttfb_comparison.png     ← 📈 生成されるグラフ          │
│  │           ├── throughput_comparison.png                             │
│  │           └── summary_report.txt                                    │
│  ├── cert/                      ← 🔐 TLS証明書（コンテナにコピー）      │
│  └── docker-compose.yml         ← Docker構成ファイル                    │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │              Docker Engine（コンテナ実行環境）                      │ │
│  │                                                                     │ │
│  │  ┌─────────────────────────────────────────────────────────────┐  │ │
│  │  │         カスタムブリッジネットワーク: benchmark-net         │  │ │
│  │  │                   (172.20.0.0/16)                           │  │ │
│  │  │                                                              │  │ │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌─────────────────┐  │  │ │
│  │  │  │  http2-server│  │ http3-server │  │ benchmark-client│  │  │ │
│  │  │  │              │  │              │  │                 │  │  │ │
│  │  │  │  Port: 2000  │  │  Port: 3000  │  │  クライアント   │  │  │ │
│  │  │  │  (TCP/HTTPS) │  │  (UDP/HTTPS) │  │  + Python分析   │  │  │ │
│  │  │  │              │  │              │  │                 │  │  │ │
│  │  │  │ 172.20.0.10  │  │ 172.20.0.11  │  │  172.20.0.20    │  │  │ │
│  │  │  │              │  │              │  │                 │  │  │ │
│  │  │  │  Go Server   │  │  Go Server   │  │  Go Client      │  │  │ │
│  │  │  │  + TLS 1.3   │  │  + QUIC      │  │  + tc (制御)    │  │  │ │
│  │  │  │              │  │              │  │  + Python 3     │  │  │ │
│  │  │  └──────────────┘  └──────────────┘  └─────────────────┘  │  │ │
│  │  │         ▲                ▲                   │             │  │ │
│  │  │         │                │                   │             │  │ │
│  │  │         └────────────────┴───────────────────┘             │  │ │
│  │  │                                                             │  │ │
│  │  │  🌐 ネットワーク制御（tc - Traffic Control）                │  │ │
│  │  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │  │ │
│  │  │  • 遅延（delay）     : 0-100ms                              │  │ │
│  │  │  • 帯域制限（bandwidth）: 1Mbps, 10Mbps, 100Mbps, 無制限   │  │ │
│  │  │  • パケット損失（loss） : （現在は未使用、拡張可能）        │  │ │
│  │  └─────────────────────────────────────────────────────────────┘  │ │
│  │                                                                     │ │
│  │  💾 ボリュームマウント:                                             │ │
│  │  ホスト: vol.2/results  ⇄  コンテナ: /app/results                 │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  🖥️ 実行スクリプト:                                                     │
│  • ./auto_benchmark.sh         (macOS/Linux) - 3条件の簡易テスト        │
│  • ./auto_benchmark.bat        (Windows)     - WSL経由で実行           │
│  • ./auto_benchmark_5mbps.sh   (macOS/Linux) - 5Mbps固定テスト         │
│  • ./test_benchmark.sh         (macOS/Linux) - カスタム条件テスト       │
└─────────────────────────────────────────────────────────────────────────┘
```

## 📊 データフロー図

```
                      ベンチマーク実行フロー
                      ═══════════════════════

1️⃣ 環境準備フェーズ
┌─────────────────────────────────────────────────────┐
│ ホスト: ./auto_benchmark.sh 実行                     │
│   ↓                                                  │
│ docker-compose down -v    ← 既存環境クリーンアップ   │
│ docker-compose build      ← イメージビルド           │
│ docker-compose up -d      ← コンテナ起動             │
│   ↓                                                  │
│ 3つのコンテナが起動（10秒待機）                       │
└─────────────────────────────────────────────────────┘

2️⃣ ベンチマーク実行フェーズ
┌─────────────────────────────────────────────────────┐
│ docker exec benchmark-client bash -c "..."           │
│   ↓                                                  │
│ セッションディレクトリ作成                            │
│   /app/results/session_20260124_123456_auto_test/   │
│   ↓                                                  │
│ 各条件について繰り返し:                               │
│   ┌─────────────────────────────────────────┐      │
│   │ ネットワーク条件設定                      │      │
│   │   set-network-conditions.sh 50 0          │      │
│   │     → tc qdisc add dev eth0 ...          │      │
│   │   ↓                                       │      │
│   │ HTTP/2ベンチマーク (30リクエスト)          │      │
│   │   /app/http2-benchmark-client             │      │
│   │     → 172.20.0.10:2000 に接続             │      │
│   │     → TTFB, Total Time, Throughput記録    │      │
│   │     → http2_results.csv に保存            │      │
│   │   ↓                                       │      │
│   │ HTTP/3ベンチマーク (30リクエスト)          │      │
│   │   /app/http3-benchmark-client             │      │
│   │     → 172.20.0.11:3000 に接続             │      │
│   │     → TTFB, Total Time, Throughput記録    │      │
│   │     → http3_results.csv に保存            │      │
│   │   ↓                                       │      │
│   │ ネットワーク条件リセット                   │      │
│   │   tc qdisc del dev eth0 root              │      │
│   └─────────────────────────────────────────┘      │
│                                                      │
│ 全条件完了                                           │
└─────────────────────────────────────────────────────┘

3️⃣ 分析・グラフ生成フェーズ
┌─────────────────────────────────────────────────────┐
│ docker exec benchmark-client python3 \               │
│   /app/scripts/analyze_results.py \                  │
│   /app/results/session_20260124_123456_auto_test/    │
│   ↓                                                  │
│ 全CSVファイル読み込み                                 │
│   ↓                                                  │
│ データ集計・統計処理                                  │
│   • 平均値、標準偏差の計算                           │
│   • 遅延ごとの性能比較                               │
│   • 帯域幅ごとの性能比較                             │
│   ↓                                                  │
│ グラフ生成（matplotlib + 日本語フォント）             │
│   • ttfb_comparison.png                              │
│   • throughput_comparison.png                        │
│   ↓                                                  │
│ テキストレポート生成                                  │
│   • summary_report.txt                               │
│   ↓                                                  │
│ 📂 /app/results/session_.../analysis/ に保存        │
└─────────────────────────────────────────────────────┘

4️⃣ 結果確認
┌─────────────────────────────────────────────────────┐
│ ホスト側でファイル確認:                               │
│   vol.2/results/session_20260124_123456_auto_test/   │
│   ├── session_info.txt                               │
│   ├── delay_0ms_bw_unlimited/                        │
│   ├── delay_50ms_bw_unlimited/                       │
│   ├── delay_100ms_bw_unlimited/                      │
│   └── analysis/                                      │
│       ├── ttfb_comparison.png      ← 📊 グラフ表示  │
│       ├── throughput_comparison.png                  │
│       └── summary_report.txt                         │
└─────────────────────────────────────────────────────┘
```

## 🔧 ネットワーク制御の詳細

```
                  tcコマンドによる制御
                  ═══════════════════

┌─────────────────────────────────────────────────────┐
│ benchmark-clientコンテナ内（eth0インターフェース）    │
│                                                      │
│  通常状態（制御なし）                                 │
│  ┌──────────────────────────────────────┐          │
│  │ eth0 → サーバーへ直接送信              │          │
│  │  遅延: 最小（コンテナ間通信）           │          │
│  │  帯域: 無制限                          │          │
│  └──────────────────────────────────────┘          │
│                                                      │
│  ↓ set-network-conditions.sh 50 0 実行               │
│                                                      │
│  制御状態（遅延50ms追加）                             │
│  ┌──────────────────────────────────────┐          │
│  │ eth0                                  │          │
│  │   ↓                                   │          │
│  │ tc qdisc (netem)                      │          │
│  │   • delay: 50ms                       │          │
│  │   • distribution: normal              │          │
│  │   ↓                                   │          │
│  │ パケット送信（50ms遅延後）             │          │
│  └──────────────────────────────────────┘          │
│                                                      │
│  ↓ set-network-conditions.sh 0 10mbit 実行           │
│                                                      │
│  制御状態（帯域10Mbps制限）                           │
│  ┌──────────────────────────────────────┐          │
│  │ eth0                                  │          │
│  │   ↓                                   │          │
│  │ tc qdisc (tbf)                        │          │
│  │   • rate: 10Mbit                      │          │
│  │   • burst: 32kB                       │          │
│  │   • latency: 400ms                    │          │
│  │   ↓                                   │          │
│  │ パケット送信（帯域制限）               │          │
│  └──────────────────────────────────────┘          │
└─────────────────────────────────────────────────────┘
```

## 🔐 TLS証明書の配置

```
証明書の生成と使用フロー
═══════════════════════

1️⃣ 初回起動時（証明書が存在しない場合）
┌─────────────────────────────────────────┐
│ サーバーコンテナ起動                      │
│   ↓                                      │
│ cert.Ensureでのチェック                   │
│   vol.2/cert/server.crt が存在？         │
│   ↓ NO                                   │
│ 自己署名証明書を生成                      │
│   • server.crt（公開鍵証明書）            │
│   • server.key（秘密鍵）                  │
│   ↓                                      │
│ vol.2/cert/ に保存                       │
└─────────────────────────────────────────┘

2️⃣ 証明書の配置（Docker内）
┌─────────────────────────────────────────┐
│ Dockerfile:                              │
│   COPY vol.2/cert /app/cert              │
│                                          │
│ コンテナ内のパス:                         │
│   /app/cert/server.crt                   │
│   /app/cert/server.key                   │
│                                          │
│ 使用箇所:                                 │
│   • http2-server: TLS 1.3で使用          │
│   • http3-server: QUIC TLSで使用         │
│   • クライアント: 証明書検証スキップ      │
│     （InsecureSkipVerify: true）         │
└─────────────────────────────────────────┘
```

## 💻 OS別の実行方法

```
┌──────────────┬─────────────────────────────────────┐
│    OS        │      実行方法                        │
├──────────────┼─────────────────────────────────────┤
│ macOS/Linux  │ ./auto_benchmark.sh                  │
│              │   ↓                                  │
│              │ bash → docker-compose → コンテナ実行 │
├──────────────┼─────────────────────────────────────┤
│ Windows      │ auto_benchmark.bat (ダブルクリック)  │
│              │   ↓                                  │
│              │ バッチファイル実行（cmd.exe）        │
│              │   ↓                                  │
│              │ Docker Desktop経由でdocker-compose   │
│              │   ↓                                  │
│              │ コンテナ実行（docker exec）          │
│              │   ↓                                  │
│              │ bash（コンテナ内Linux環境）          │
└──────────────┴─────────────────────────────────────┘
```

## 📦 コンテナの詳細

### http2-server コンテナ
```
役割: HTTP/2サーバー
言語: Go
プロトコル: HTTP/2 over TLS 1.3 (TCP)
ポート: 2000 (TCP)
IPアドレス: 172.20.0.10
レスポンス: 1MBのランダムデータ
特権: NET_ADMIN（ネットワーク設定用）
```

### http3-server コンテナ
```
役割: HTTP/3サーバー
言語: Go (quic-go ライブラリ)
プロトコル: HTTP/3 over QUIC (UDP)
ポート: 3000 (UDP)
IPアドレス: 172.20.0.11
レスポンス: 1MBのランダムデータ
特権: NET_ADMIN（ネットワーク設定用）
```

### benchmark-client コンテナ
```
役割: ベンチマーククライアント + 分析ツール
言語: Go (クライアント) + Python (分析)
機能:
  1. ネットワーク条件制御（tc コマンド）
  2. HTTP/2, HTTP/3へのリクエスト送信
  3. 性能測定（TTFB, Total Time, Throughput）
  4. データ分析・グラフ生成（Python）
IPアドレス: 172.20.0.20
ボリューム: ./results → /app/results（双方向）
特権: NET_ADMIN（tc コマンド使用）
コマンド: sleep infinity（常時起動）
```

## 🎯 測定メトリクス

```
┌──────────────────┬─────────────────────────────────┐
│ メトリクス名      │ 説明                            │
├──────────────────┼─────────────────────────────────┤
│ TTFB             │ Time To First Byte              │
│ (Time To First   │ リクエスト送信から最初の1バイト │
│  Byte)           │ を受信するまでの時間（ms）      │
│                  │ → 接続確立 + サーバー処理時間   │
├──────────────────┼─────────────────────────────────┤
│ Total Time       │ リクエスト送信から全データ受信  │
│                  │ 完了までの時間（ms）            │
│                  │ → TTFB + データ転送時間         │
├──────────────────┼─────────────────────────────────┤
│ Throughput       │ スループット（MB/s）            │
│                  │ データサイズ ÷ Total Time       │
│                  │ → 実効的な転送速度              │
└──────────────────┴─────────────────────────────────┘
```

## 🔄 実験の再現性

すべての実験は以下の条件で統一されています:

```
✅ 固定条件:
  • データサイズ: 1MB（各リクエスト）
  • リクエスト数: 30回（各条件）
  • Docker内での実行（環境の完全な分離）
  • 同一ネットワークセグメント（172.20.0.0/16）
  • 自己署名証明書（同一の暗号化条件）

✅ 変動条件:
  • 遅延: 0-100ms（設定可能）
  • 帯域幅: 1Mbps-無制限（設定可能）

✅ 記録内容:
  • 実験日時
  • ネットワーク条件
  • 全リクエストの詳細データ（CSV）
  • 統計サマリー（平均、標準偏差）
```

---

この構成により、**完全に再現可能で、OS非依存な性能測定環境**が実現されています。

